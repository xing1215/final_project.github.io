---
title: "data source"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(scales)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

# data cleaning

## read the leagueoflegends.csv

```{r,message=FALSE, warning=FALSE}
leagueoflegends = 
  read_csv(file = "./data/LeagueofLegends.csv") %>% 
  janitor::clean_names() %>% 
  mutate(address = str_remove(address, "http://matchhistory.na.leagueoflegends.com/en/#match-details/TRLH1/")) %>% 
  select(address, year, b_result)
```


## read and clean the tower data

```{r,message=FALSE, warning=FALSE}
tower = 
  read_csv(file = "./data/structures.csv") %>% 
  janitor::clean_names() %>% 
  filter(type == "OUTER_TURRET") %>% 
  mutate(
    address = str_remove(address, "http://matchhistory.na.leagueoflegends.com/en/#match-details/TRLH1/")
  )
```

calculate the mean time, group by match id

```{r,message=FALSE, warning=FALSE}
tower = 
  tower %>% 
  group_by(address, team) %>% 
  mutate(
    outer_tower = mean(time, na.rm = TRUE)
  ) %>% 
  select(-lane, -time, -type) %>%
  distinct() %>% 
  pivot_wider(
    names_from = team,
    values_from = outer_tower
  ) %>% 
  mutate(outer_mean_diff = bTowers - rTowers)
```

join with the leagueoflegend dataset

```{r,message=FALSE, warning=FALSE}
merge_file = 
  left_join(leagueoflegends, tower, by = "address") %>% 
  mutate(b_result = recode_factor(b_result, "1" = "win", "0" = "lose"))
```

some visualizations

```{r,message=FALSE, warning=FALSE}
merge_file %>% 
  ggplot(aes(x = b_result, y = outer_mean_diff)) + 
  geom_boxplot()
```

bTower means the mean time blue team destroy enemy's outer towers among three lanes, rTower means the mean time red team destroy enemy's outer towers among three lanes. We care about the impact of different of mean time between two groups. from the plot, we can see that if bTower is smaller than rTower (meaning that blue teams destroy red teams' outer tower faster) there will be a higher win rate among blue teams


## read and clean the gold data

```{r,message=FALSE, warning=FALSE}
gold = 
  read_csv(file = "./data/gold.csv") %>% 
  janitor::clean_names() %>% 
  filter(type == "golddiff") %>% 
  mutate(
    address = str_remove(address, "http://matchhistory.na.leagueoflegends.com/en/#match-details/TRLH1/")
  ) %>% 
  pivot_longer(
    min_1:min_95,
    names_to = "min", 
    names_prefix = "min_",
    values_to = "gold"
  ) %>% 
  drop_na()

gold_ave =
  gold %>% 
  group_by(address) %>% 
  summarize(
    golddiff_mean = mean(gold)
  )
```

combine

```{r,message=FALSE, warning=FALSE}
merge_file = left_join(merge_file, gold_ave, by = "address")
```

```{r,message=FALSE, warning=FALSE}
merge_file %>% 
  ggplot(aes(x = b_result, y = golddiff_mean)) + 
  geom_boxplot()
```

The figure above shows the average gold difference across the whole game when blue team wins and blue team loses. The gold difference is calculated by the total gold of blue team minus that of red team in every minutes of the game. As we expected, the average mean of gold difference should be higher when blue team wins the game. 


## read and clean the neutral kills data

```{r,message=FALSE, warning=FALSE}
monster = 
  read_csv("./data/monsters.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    address = str_remove(address, "http://matchhistory.na.leagueoflegends.com/en/#match-details/TRLH1/")
  )

monster = 
  monster %>% 
  filter(team %in% c("bDragons", "bBarons", "bHeralds")) %>% 
  group_by(address, type) %>% 
  summarize(number = n()) %>% 
  pivot_wider(
    names_from = type,
    values_from = number
  ) 
monster[is.na(monster)] = 0
```

merge

```{r,message=FALSE, warning=FALSE}
merge_file = left_join(merge_file, monster, by = "address")
```

visualizations

```{r,message=FALSE, warning=FALSE}
origin_df = read_csv("./data/LeagueofLegends.csv") %>% janitor::clean_names()

blank_theme <- theme_minimal() +
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.ticks = element_blank(),
  plot.title = element_text(size = 14, face = "bold")
  )
origin_df %>% 
  select(b_result, r_result) %>% 
  mutate(b_wins = sum(b_result), r_wins = sum(r_result), total = b_wins + r_wins) %>% 
  select(b_wins:total) %>%
  pivot_longer(
    b_wins:r_wins,
    names_to = "team",
    values_to = "game_won"
  ) %>% 
  filter(row_number() <= 2) %>% 
  ggplot(aes(x = "", y = game_won, fill = team)) +
  geom_bar(stat = "identity", width = 1) +
  geom_text(aes(label = percent(game_won / total)), position = position_stack(vjust = 0.5)) +
  coord_polar("y") +
  labs(  
    title = "Win rates of Blue and Red teams across all years"
  ) +
  scale_fill_manual(labels = c("Blue", "Red"), values = c("cadetblue1", "coral1")) + 
  blank_theme +
  theme(axis.text.x = element_blank())
```


## read and clean the kills data

```{r,message=FALSE, warning=FALSE}
kills <- read_csv("./data/kills.csv") %>% 
  janitor::clean_names() %>% 
  mutate(address = str_remove(address,
        "http://matchhistory.na.leagueoflegends.com/en/#match-details/TRLH1/")) %>%         
  group_by(address,team) %>%
  select(address,team) %>% 
  summarize(n = n()) %>% 
  pivot_wider(
    names_from = "team",
    values_from = "n") %>%
  mutate(diff = bKills - rKills)
## merge kills to merge_file.csv
merge_file <- left_join(merge_file,kills,by="address")
## relevel b_results
merge_file <- merge_file %>% 
  mutate(b_result = relevel(b_result,"lose"))

```

do some visualization

```{r,message=FALSE, warning=FALSE}
merge_file %>% ggplot(aes(x = diff,y = b_result)) + 
  geom_point()
merge_file %>%  ggplot((aes(x = b_result,y = diff,group = b_result))) +
  geom_boxplot() +
  coord_flip()
merge_file %>% ggplot(aes(x = diff,y = b_result)) + 
  geom_point(alpha = 0.5) +
  stat_smooth(method = "glm", se = FALSE, fullrange = TRUE, 
              method.args = list(family = binomial))
```

## export to csv

```{r}
write.csv(merge_file,"./data/merge.csv", row.names = FALSE)
```


